name: Rover Medical System - CI/CD

on:
  push:
    branches: ["main"]

  workflow_dispatch:
    inputs:
      release:
        description: "Demo release to run (release-1, release-2, release-3...)"
        required: true
        default: "release-1"
      nape_version:
        description: "NAPE CLI version to install"
        required: false
        default: 1.1.0

jobs:
  assured_release:
    runs-on: ubuntu-latest

    env:
      # Default release when this runs from a push (no inputs context)
      RELEASE: ${{ inputs.release || 'release-1' }}
      SUBJECT_ID: ${{ github.run_id }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Checkout evidence collection (Ansible) repo
        uses: actions/checkout@v4
        with:
          repository: attestify/rover-medical-evidence-collection
          path: rover-medical-evidence-collection

      - name: Show evidence collection repo structure
        shell: bash
        run: |
          set -euo pipefail
          echo "Contents of rover-medical-evidence-collection:"
          tree rover-medical-evidence-collection -L 5

      - name: Resolve release
        id: rel
        uses: ./.github/actions/determine-release

      - name: Show release
        run: |
          set -euo pipefail
          echo "Release output is: ${{ steps.rel.outputs.release }}"
          echo "RELEASE env var is: ${RELEASE}"

      - name: Install NAPE CLI
        uses: ./.github/actions/setup-nape
        with:
          version: 1.1.0

      - name: Install Ansible
        shell: bash
        run: |
          set -euo pipefail
          python3 -m pip install --upgrade pip
          python3 -m pip install ansible

      - name: Aggregate Evidence from other parts of Rover Medical System
        shell: bash
        run: |
          set -euo pipefail

          cat > rover-medical-evidence-collection/ansible/ansible.cfg <<'CFG'
          [defaults]
          roles_path = ./roles
          inventory = ./inventory/demo.ini
          host_key_checking = False
          retry_files_enabled = False
          CFG

          export ANSIBLE_CONFIG="${GITHUB_WORKSPACE}/rover-medical-evidence-collection/ansible/ansible.cfg"


          # Run the playbook from the evidence collection repo
          # It should read rover-medical-system/${RELEASE} as the "canned" source
          # and write collected artifacts into rover-medical-system/${RELEASE}/evidence/runtime/remote/...
          ansible-playbook \
            rover-medical-evidence-collection/ansible/playbooks/collect-evidence.yml \
            -e "release=${RELEASE}" \
            -e "rover_system_root=${GITHUB_WORKSPACE}/rover-medical-system"


          echo "=== Workspace top level ==="
          tree -L 6 "${GITHUB_WORKSPACE}"

          echo "=== Rover medical system (where evidence should land) ==="
          tree -L 8 "${GITHUB_WORKSPACE}/rover-medical-system/${RELEASE}" || true

          echo "=== Runtime evidence output ==="
          tree -L 8 "${GITHUB_WORKSPACE}/rover-medical-system/${RELEASE}/evidence/runtime" || true

      - name: NAPE - Start Evidence Collection
        shell: bash
        run: |
          set -euo pipefail

          SUBJECT_ID=$(date +%s%3N)

          nape collect start \
            --subject "nrn:procedure:rover-medical/rover-medicine-system"  \
            --subject-id "$SUBJECT_ID" \
            --procedure-link "https://github.com/attestify/rover-medical-catalog.git" \
            --procedure-directory "rover-mediical-system/${RELEASE}" \
            --meta system-owner "Bill Bensing"

          nape collect evidence \
            --control-activity "pet-medicine-app" \
            --file-path "pet-medicine-app/app-config.toml"

          nape collect evidence \
            --control-activity "pet-medicine-db" \
            --file-path "pet-medicine-db/my-db.ini"

          nape collect report

      - name: Upload NAPE run directory
        uses: actions/upload-artifact@v4
        with:
          name: rover-medical-system-${{ env.RELEASE }}
          path: |
            nrn*